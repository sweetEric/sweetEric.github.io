I"ìn<h3 id="ä¸€aopæ˜¯ä»€ä¹ˆ">ä¸€ã€Aopæ˜¯ä»€ä¹ˆ</h3>

<p>ä¸OOPå¯¹æ¯”ï¼Œé¢å‘åˆ‡é¢ï¼Œä¼ ç»Ÿçš„OOPå¼€å‘ä¸­çš„ä»£ç é€»è¾‘æ˜¯è‡ªä¸Šè€Œä¸‹çš„ï¼Œè€Œè¿™äº›è¿‡ç¨‹ä¼šäº§ç”Ÿä¸€äº›æ¨ªåˆ‡æ€§é—®é¢˜ï¼Œè¿™äº›æ¨ªåˆ‡æ€§çš„é—®é¢˜å’Œæˆ‘ä»¬çš„ä¸»ä¸šåŠ¡é€»è¾‘å…³ç³»ä¸å¤§ï¼Œè¿™äº›æ¨ªåˆ‡æ€§é—®é¢˜ä¸ä¼šå½±å“åˆ°ä¸»é€»è¾‘å®ç°çš„ï¼Œä½†æ˜¯ä¼šæ•£è½åˆ°ä»£ç çš„å„ä¸ªéƒ¨åˆ†ï¼Œéš¾ä»¥ç»´æŠ¤ã€‚AOPæ˜¯å¤„ç†äº›æ¨ªåˆ‡æ€§é—®é¢˜ï¼ŒAOPçš„ç¼–ç¨‹æ€æƒ³å°±æ˜¯æŠŠè¿™äº›é—®é¢˜å’Œä¸»ä¸šåŠ¡é€»è¾‘åˆ†å¼€ï¼Œè¾¾åˆ°ä¸»ä¸šåŠ¡é€»è¾‘è§£è€¦çš„ç›®çš„ï¼Œä½¿ä»£ç çš„é‡ç”¨æ€§å’Œå¼€å‘æ•ˆç‡æ›´é«˜ã€‚<br />
ä½¿ç”¨åœºæ™¯</p>
<ol>
  <li>æ—¥å¿—è®°å½•</li>
  <li>æƒé™éªŒè¯</li>
  <li>æ•ˆç‡æ£€æŸ¥</li>
  <li>äº‹åŠ¡ç®¡ç†</li>
</ol>

<h3 id="äºŒaspectj-å’Œ-spring-aop-çš„åŒºåˆ«">äºŒã€AspectJ å’Œ spring aop çš„åŒºåˆ«</h3>
<p>AspectJ ä¸ºé™æ€ä»£ç†, è€Œspring aopåŒ…æ‹¬JDKä»£ç†å’Œcglibä»£ç†, éƒ½æ˜¯åŠ¨æ€ä»£ç†ã€‚</p>

<h3 id="ä¸‰spring-aopä½¿ç”¨æµç¨‹">ä¸‰ã€Spring aopä½¿ç”¨æµç¨‹</h3>
<p>å¦‚æœæƒ³è¯¦ç»†äº†è§£ Spring aop çš„ç»†èŠ‚å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£  <br />
 https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop</p>
<ol>
  <li>åˆ›å»ºä»£ç†</li>
  <li>åˆ›å»ºåˆ‡ç‚¹(point cut)</li>
  <li>åˆ›å»ºé€šçŸ¥(advice)execution()</li>
</ol>

<p>ç°åœ¨æˆ‘ä»¬å°è¯•åˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œè¿›è¡Œé¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚  <br />
å¯å‚è€ƒ https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/core.html#aop-ataspectj</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="sr">//</span><span class="err">åˆ›å»ºæ¥å£</span> <span class="no">A</span>
<span class="kp">public</span> <span class="n">interface</span> <span class="no">A</span> <span class="p">{</span>
    <span class="n">void</span> <span class="nb">print</span><span class="p">();</span>
<span class="p">}</span>

<span class="sr">//</span><span class="err">åˆ›å»ºç»„ä»¶</span><span class="no">AA</span>
<span class="vi">@Component</span><span class="p">(</span><span class="s2">"AA"</span><span class="p">)</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">AA</span> <span class="n">implements</span> <span class="no">A</span><span class="p">{</span>
    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="n">void</span> <span class="nb">print</span><span class="p">(){</span>
        <span class="no">System</span><span class="p">.</span><span class="nf">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="nf">getClass</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="vi">@Override</span>
    <span class="kp">public</span> <span class="no">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">"AA++"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="sr">//</span><span class="err">æ‰§è¡Œçš„ä¸»é€»è¾‘</span>
<span class="vi">@RunWith</span><span class="p">(</span><span class="no">SpringRunner</span><span class="p">.</span><span class="nf">class</span><span class="p">)</span>
<span class="vi">@SpringBootTest</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">AspectjTest</span> <span class="p">{</span>

    <span class="vi">@Test</span>
    <span class="kp">public</span> <span class="n">void</span> <span class="no">Aspectj</span><span class="p">(){</span>
        <span class="no">ConfigurableApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="no">SpringApplication</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="no">HpmontApplication</span><span class="p">.</span><span class="nf">class</span><span class="p">);</span>

        <span class="no">System</span><span class="p">.</span><span class="nf">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>
        <span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="no">A</span><span class="p">)</span> <span class="n">context</span><span class="p">.</span><span class="nf">getBean</span><span class="p">(</span><span class="s2">"AA"</span><span class="p">);</span>
        <span class="n">a</span><span class="p">.</span><span class="nf">print</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre></figure>

<h4 id="ç°åœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªç»„ä»¶è¿›è¡Œåˆ‡é¢ç¼–ç¨‹ä¹Ÿå°±æ˜¯å¢å¼º">ç°åœ¨æˆ‘ä»¬å¯¹è¿™ä¸ªç»„ä»¶è¿›è¡Œåˆ‡é¢ç¼–ç¨‹ï¼Œä¹Ÿå°±æ˜¯å¢å¼º</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="sr">//</span><span class="err">å¯ç”¨ä»£ç†</span>
<span class="vi">@Configuration</span>
<span class="vi">@EnableAspectJAutoProxy</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">AppConfig</span> <span class="p">{</span>

<span class="p">}</span>

<span class="sr">//</span><span class="err">å®šä¹‰ä»£ç†ç±»</span>
<span class="vi">@Component</span>
<span class="vi">@Aspect</span>
<span class="kp">public</span> <span class="k">class</span> <span class="nc">TestAspectJ</span> <span class="p">{</span>

    <span class="vi">@Pointcut</span><span class="p">(</span><span class="s2">"execution(* com.hpmont.springiot.aspectj..*.*(..))"</span><span class="p">)</span>
    <span class="kp">public</span> <span class="n">void</span> <span class="n">pointCut</span><span class="p">(){</span>

    <span class="p">}</span>

    <span class="vi">@Before</span><span class="p">(</span><span class="s2">"pointCut()"</span><span class="p">)</span>
    <span class="kp">public</span> <span class="n">void</span> <span class="n">advice</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="no">System</span><span class="p">.</span><span class="nf">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s2">"aop before--logging"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="vi">@After</span><span class="p">(</span><span class="s2">"pointCut()"</span><span class="p">)</span>
    <span class="kp">public</span> <span class="n">void</span> <span class="n">advice1</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="no">System</span><span class="p">.</span><span class="nf">out</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s2">"aop after--logging"</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>

<span class="err">å¯ç”¨ä»£ç†å‰</span>
<span class="k">class</span> <span class="n">com</span><span class="p">.</span><span class="nf">hpmont</span><span class="p">.</span><span class="nf">springiot</span><span class="p">.</span><span class="nf">aspectj</span><span class="o">.</span><span class="no">AA</span>

<span class="err">å¯ç”¨ä»£ç†å</span>
<span class="n">aop</span> <span class="n">before</span><span class="o">--</span><span class="n">logging</span>
<span class="k">class</span> <span class="n">com</span><span class="p">.</span><span class="nf">hpmont</span><span class="p">.</span><span class="nf">springiot</span><span class="p">.</span><span class="nf">aspectj</span><span class="o">.</span><span class="no">AA</span>
<span class="n">aop</span> <span class="n">after</span><span class="o">--</span><span class="n">logging</span></code></pre></figure>

<blockquote>
  <p>åˆ›å»ºåˆ‡ç‚¹éœ€è¦éµå¾ªç›¸å…³è¯­æ³•  <br />
execution(modifiers-pattern? ret-type-pattern declaring-type-pattern? name-pattern(param-pattern) throws-pattern?)   <br />
è¿™é‡Œé—®å·è¡¨ç¤ºå½“å‰é¡¹å¯ä»¥æœ‰ä¹Ÿå¯ä»¥æ²¡æœ‰ï¼Œå…¶ä¸­å„é¡¹çš„è¯­ä¹‰å¦‚ä¸‹:  <br />
modifiers- pattern:æ–¹æ³•çš„å¯è§æ€§ï¼Œå¦‚ public, protected  <br />
ret-type- pattern:æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œå¦‚int,voidç­‰declaring-type- pattern:æ–¹æ³•æ‰€åœ¨ç±»çš„å…¨è·¯å¾„åï¼Œå¦‚com, spring. Aspect;  <br />
name- pattern:æ–¹æ³•åç±»å‹ï¼Œå¦‚ buisinessservice() <br />
param- pattern:æ–¹æ³•çš„å‚æ•°ç±»å‹ï¼Œå¦‚java.lang. string;  <br />
throws- pattern:æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹ï¼Œå¦‚java.Lang.Exception   <br />
example: <br />
pointcut(â€œexecution(* com.chenss.dao.<em>.</em>(..))â€)//é…com. chess.daoåŒ…ä¸‹çš„ä»»æ„æ¥å›—å’Œç±»çš„ä»»æ„æ–¹æ³•  <br />
pointcut(â€œexecution( pubLic * com.chenss.dao.<em>.</em>(..))â€)//åŒ¹é…com, chess.daoåŒ…ä¸‹çš„ä»»æ„æ¥å£å’Œç±»çš„ publicæ–¹æ³•   <br />
@Pointcut(â€œexecution(pubLic* com.chenss.dao.<em>.</em>())â€)//gUEL com, chess.daoåŒ…ä¸‹çš„ä»»æ„æ¥å£å’Œç±»çš„ pubLicæ— æ–¹æ³•å‚æ•°çš„æ–¹æ³•   <br />
@Pointcut(â€œexecution(* com.chens dao.<em>.</em>(java.lang.String, ..))â€)//20é…com, chess.daoåŒ…ä¸‹çš„ä»»æ„æ¥å›—å’Œç±»çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º stringç±»å‹çš„æ–¹æ³•</p>
</blockquote>

<p>spring aop æºç åˆ†æ
springä¸­çš„aopå’ŒAspectJå®ç°æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„aopä½¿ç”¨çš„åŠ¨æ€ä»£ç†ï¼ŒAspectJä½¿ç”¨çš„æ˜¯é™æ€ä»£ç†ï¼Œæˆ‘ä¸»è¦åˆ†æçš„æ˜¯spring aopçš„JDKåŠ¨æ€ä»£ç†ã€‚é€šè¿‡é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œæˆ‘ä»¬ä¸ä¼šå½±å“åŸOOPæµç¨‹, åªæ˜¯åœ¨åŸæ¥çš„æµç¨‹ä¸Šåˆ‡é¢æ³¨å…¥æ–°çš„åŠŸèƒ½ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œ  <br />
ä¸€ã€é€šè¿‡ç»§æ‰¿OOPæµç¨‹ä¸­çš„æŸä¸ªç±»ï¼Œå¯¹æŸä¸ªèŠ‚ç‚¹è¿›è¡Œå¢å¼º  <br />
äºŒã€new ä¸€ä¸ªä»£ç†ç±»æŠŠåŸæœ‰æ–¹æ³•å¤åˆ¶ä¸€ä»½ï¼Œå¹¶å¯¹å…¶å¢å¼ºã€‚ <br />
<img src="http://localhost:4000/assets/images/postImg/spring-oop-aop.png" alt="spring-oop-aop" />   <br />
daili
æˆ‘ä»¬éœ€è¦åœ¨æºç ä¸­æ‰¾å‡ºåŠ¨æ€ä»£ç†ç±»æ˜¯å¦‚ä½•æ›¿æ¢åŸæ¥çš„ç±»çš„å¹¶æ€ä¹ˆè¿›è¡Œå¢å¼ºã€‚åœ¨spring beanä¸­ï¼Œbeanfactoryå­˜å‚¨äº†æ‰€æœ‰æˆ‘ä»¬è‡ªå®šä¹‰æˆ–è€…ç³»ç»Ÿé»˜è®¤çš„beanï¼Œå…¶ä¸­å¤§éƒ¨åˆ†åœ¨singletonObjectsä¸­ç»´æŠ¤ï¼Œç°åœ¨è°ƒè¯•æ‰¾å‡ºsingletonObjectsæ˜¯æ€ä¹ˆç»´æŠ¤bean mapçš„ã€‚</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="sr">//</span><span class="no">DefaultSingletonBeanRegistry</span><span class="p">.</span><span class="nf">java</span>
<span class="kp">protected</span> <span class="n">void</span> <span class="n">addSingleton</span><span class="p">(</span><span class="no">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="no">Object</span> <span class="n">singletonObject</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">synchronized</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="nf">singletonObjects</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">this</span><span class="p">.</span><span class="nf">singletonObjects</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">singletonObject</span><span class="p">);</span>
    <span class="n">this</span><span class="p">.</span><span class="nf">singletonFactories</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
    <span class="n">this</span><span class="p">.</span><span class="nf">earlySingletonObjects</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
    <span class="n">this</span><span class="p">.</span><span class="nf">registeredSingletons</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p><img src="http://localhost:4000/assets/images/postImg/debug-aop.png" alt="debug-aop" /></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="sr">//</span><span class="err">æ‰¾åˆ°</span> <span class="n">doGetBean</span> 
<span class="sr">//</span> <span class="no">Create</span> <span class="n">bean</span> <span class="n">instance</span><span class="p">.</span>
<span class="nf">if</span> <span class="p">(</span><span class="n">mbd</span><span class="p">.</span><span class="nf">isSingleton</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">sharedInstance</span> <span class="o">=</span> <span class="n">getSingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
    <span class="n">try</span> <span class="p">{</span>

      <span class="sr">//</span><span class="err">è¿™é‡Œæ˜¯åˆ›å»º</span><span class="n">bean</span>
      <span class="k">return</span> <span class="n">createBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kp">catch</span> <span class="p">(</span><span class="no">BeansException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="sr">//</span> <span class="no">Explicitly</span> <span class="n">remove</span> <span class="n">instance</span> <span class="n">from</span> <span class="n">singleton</span> <span class="ss">cache: </span><span class="no">It</span> <span class="n">might</span> <span class="n">have</span> <span class="n">been</span> <span class="n">put</span> <span class="n">there</span>
      <span class="sr">//</span> <span class="n">eagerly</span> <span class="n">by</span> <span class="n">the</span> <span class="n">creation</span> <span class="n">process</span><span class="p">,</span> <span class="n">to</span> <span class="n">allow</span> <span class="k">for</span> <span class="n">circular</span> <span class="n">reference</span> <span class="n">resolution</span><span class="p">.</span>
      <span class="nf">/</span><span class="o">/</span> <span class="no">Also</span> <span class="n">remove</span> <span class="n">any</span> <span class="n">beans</span> <span class="n">that</span> <span class="n">received</span> <span class="n">a</span> <span class="n">temporary</span> <span class="n">reference</span> <span class="n">to</span> <span class="n">the</span> <span class="n">bean</span><span class="p">.</span>
      <span class="nf">destroySingleton</span><span class="p">(</span><span class="n">beanName</span><span class="p">);</span>
      <span class="kp">throw</span> <span class="n">ex</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="n">bean</span> <span class="o">=</span> <span class="n">getObjectForBeanInstance</span><span class="p">(</span><span class="n">sharedInstance</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> 
<span class="kp">protected</span> <span class="no">Object</span> <span class="n">createBean</span><span class="p">(</span><span class="no">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="no">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="vi">@Nullable</span> <span class="no">Object</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
			<span class="n">throws</span> <span class="no">BeanCreationException</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="n">try</span> <span class="p">{</span>

    <span class="sr">//</span><span class="err">æ³¨æ„è¿™é‡Œ</span>
    <span class="no">Object</span> <span class="n">beanInstance</span> <span class="o">=</span> <span class="n">doCreateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbdToUse</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="nf">isTraceEnabled</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">logger</span><span class="p">.</span><span class="nf">trace</span><span class="p">(</span><span class="s2">"Finished creating instance of bean '"</span> <span class="o">+</span> <span class="n">beanName</span> <span class="o">+</span> <span class="s2">"'"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">beanInstance</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>


<span class="sr">//</span><span class="err">å¾€ä¸‹èµ°çœ‹åˆ°</span>
<span class="kp">protected</span> <span class="no">Object</span> <span class="n">doCreateBean</span><span class="p">(</span><span class="n">final</span> <span class="no">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">final</span> <span class="no">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">final</span> <span class="vi">@Nullable</span> <span class="no">Object</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
			<span class="n">throws</span> <span class="no">BeanCreationException</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="n">try</span> <span class="p">{</span>
    <span class="n">populateBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">mbd</span><span class="p">,</span> <span class="n">instanceWrapper</span><span class="p">);</span>
    <span class="sr">//</span><span class="err">æ³¨æ„è¿™é‡Œ</span>
    <span class="n">exposedObject</span> <span class="o">=</span> <span class="n">initializeBean</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">exposedObject</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">...</span>
<span class="p">}</span>

<span class="sr">//</span><span class="err">å¾€ä¸‹èµ°çœ‹åˆ°</span>
<span class="kp">protected</span> <span class="no">Object</span> <span class="n">initializeBean</span><span class="p">(</span><span class="n">final</span> <span class="no">String</span> <span class="n">beanName</span><span class="p">,</span> <span class="n">final</span> <span class="no">Object</span> <span class="n">bean</span><span class="p">,</span> <span class="vi">@Nullable</span> <span class="no">RootBeanDefinition</span> <span class="n">mbd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="no">System</span><span class="p">.</span><span class="nf">getSecurityManager</span><span class="p">()</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
			<span class="no">AccessController</span><span class="p">.</span><span class="nf">doPrivileged</span><span class="p">((</span><span class="no">PrivilegedAction</span><span class="o">&lt;</span><span class="no">Object</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">{</span>
				<span class="n">invokeAwareMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">bean</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">null</span><span class="p">;</span>
			<span class="p">},</span> <span class="n">getAccessControlContext</span><span class="p">());</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">invokeAwareMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">bean</span><span class="p">);</span>
		<span class="p">}</span>

    <span class="sr">//</span><span class="err">è¿™é‡ŒæŠŠ</span><span class="n">bean</span><span class="err">ç»™äº†</span><span class="n">wrappedBean</span>
		<span class="no">Object</span> <span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">bean</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="n">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="nf">isSynthetic</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsBeforeInitialization</span><span class="p">(</span><span class="n">wrappedBean</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">try</span> <span class="p">{</span>
			<span class="n">invokeInitMethods</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span> <span class="n">wrappedBean</span><span class="p">,</span> <span class="n">mbd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="kp">catch</span> <span class="p">(</span><span class="no">Throwable</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
			<span class="kp">throw</span> <span class="n">new</span> <span class="no">BeanCreationException</span><span class="p">(</span>
					<span class="p">(</span><span class="n">mbd</span> <span class="o">!=</span> <span class="n">null</span> <span class="p">?</span> <span class="n">mbd</span><span class="p">.</span><span class="nf">getResourceDescription</span><span class="p">()</span> <span class="p">:</span> <span class="n">null</span><span class="p">),</span>
					<span class="n">beanName</span><span class="p">,</span> <span class="s2">"Invocation of init method failed"</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mbd</span> <span class="o">==</span> <span class="n">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">mbd</span><span class="p">.</span><span class="nf">isSynthetic</span><span class="p">())</span> <span class="p">{</span>

      <span class="sr">//</span><span class="err">åœ¨è¿™é‡Œä¹‹å</span><span class="n">bean</span><span class="err">çš„åç§°å‘ç”Ÿäº†æ”¹å˜ï¼Œæ–¹æ³•ä¹Ÿä¿®æ”¹äº†</span>
			<span class="n">wrappedBean</span> <span class="o">=</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="p">(</span><span class="n">wrappedBean</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">wrappedBean</span><span class="p">;</span>
	<span class="p">}</span>

<span class="sr">//</span><span class="err">å¾€ä¸‹èµ°çœ‹åˆ°</span>
<span class="kp">public</span> <span class="no">Object</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="p">(</span><span class="no">Object</span> <span class="n">existingBean</span><span class="p">,</span> <span class="no">String</span> <span class="n">beanName</span><span class="p">)</span>
    <span class="n">throws</span> <span class="no">BeansException</span> <span class="p">{</span>

  <span class="no">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">existingBean</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="no">BeanPostProcessor</span> <span class="n">processor</span> <span class="p">:</span> <span class="n">getBeanPostProcessors</span><span class="p">())</span> <span class="p">{</span>
    <span class="no">Object</span> <span class="n">current</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="sr">//</span><span class="err">å¾€ä¸‹èµ°çœ‹åˆ°</span>
<span class="vi">@Override</span>
<span class="kp">public</span> <span class="no">Object</span> <span class="n">applyBeanPostProcessorsAfterInitialization</span><span class="p">(</span><span class="no">Object</span> <span class="n">existingBean</span><span class="p">,</span> <span class="no">String</span> <span class="n">beanName</span><span class="p">)</span>
    <span class="n">throws</span> <span class="no">BeansException</span> <span class="p">{</span>

  <span class="no">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">existingBean</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="no">BeanPostProcessor</span> <span class="n">processor</span> <span class="p">:</span> <span class="n">getBeanPostProcessors</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">proxyTargetClass</span><span class="o">=</span><span class="kp">true</span><span class="p">;</span> <span class="n">optimize</span><span class="o">=</span><span class="kp">false</span><span class="p">;</span> <span class="n">opaque</span><span class="o">=</span><span class="kp">false</span><span class="p">;</span> <span class="n">exposeProxy</span><span class="o">=</span><span class="kp">false</span><span class="p">;</span> <span class="n">frozen</span><span class="o">=</span><span class="kp">false</span>
    <span class="sr">//</span><span class="err">ä¼šåœ¨å£°æ˜çš„ä»£ç†ä¸­æ‰¾æ˜¯å¦æœ‰éœ€è¦ä»£ç†çš„</span><span class="n">bean</span><span class="err">ï¼Œæœ‰å°±ä¼šåˆ›å»ºä»£ç†è¿›è¡Œæ›¿æ¢</span>
    <span class="no">Object</span> <span class="n">current</span> <span class="o">=</span> <span class="n">processor</span><span class="p">.</span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">beanName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>æ€»ç»“ä¸€ä¸‹: æœ‰ä¸Šé¢è¿‡ç¨‹æˆ‘ä»¬çŸ¥é“ï¼Œspringæ˜¯åœ¨éœ€è¦è¿›è¡Œåˆ‡é¢ç¼–ç¨‹çš„beanåˆ›å»ºçš„æ—¶å€™åˆ›å»ºçš„åŠ¨æ€ä»£ç†ï¼Œå¹¶ç”¨åŠ¨æ€ä»£ç†æ›¿æ¢æ‰åŸæ¥çš„bean, ä»è€Œå®ç°spring aopçš„</p>

<!-- å‚è€ƒ
[Javaæ¶æ„å¸ˆè¯¾ç¨‹â€”â€”spring AOPæ ¸å¿ƒåº•å±‚åŸç†æ•™ç¨‹å…¨é›†][aop]
[aop]: https://www.bilibili.com/video/av66845675 -->

<!-- aopå’Œiocå…³ç³»    
å…¶å®è¿™ä¸ªé¢˜ç›®æœ¬èº«æ„ä¹‰ä¸å¤§ï¼ŒIOCå’ŒAOPéƒ½æ˜¯ç¼–ç¨‹ç›®æ ‡å’Œgæ²¡æœ‰å…³ç³»ï¼Œå°±ç®—æ²¡æœ‰springä¹Ÿèƒ½å®ç°AOPï¼Œæ¯”å¦‚å¤§åé¼é¼çš„ AspectæŠ€æœ¯ä¹Ÿèƒ½å®ç°Aopã€‚å¦‚æœç¡¬æ˜¯è¦è¯´å…³ç³»åº”è¯¥è¯´ springçš„IoCå’ŒspringAopæœ‰ä»€ä¹ˆå…³ç³»,æ— é springAopå½“ä¸­çš„å¯¹è±¡å¿…é¡»åœ¨Iocå®¹å™¨å½“ä¸­ã€‚æ¯”å¦‚Aspectå°±å¯ä»¥è„«ç¦»OCå•ç‹¬ä½¿ç”¨ï¼Œä½†æ˜¯ springAopå°±ä¸èƒ½è„±ç¦»Iocã€‚ -->
:ET